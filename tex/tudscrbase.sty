%*******************************************************************************%
%*******************************************************************************%
%****** Anpassung und Erweiterung der KOMA-Script-Klassen **********************%
%****** im CD der TU Dresden ***************************************************%
%****** Autor: Falk Hanisch ****************************************************%
%*******************************************************************************%
%****** Basis waren die TUD-Vorlagen von Klaus Bergmann (tudbook, tudthesis) ***%
%*******************************************************************************%
%*******************************************************************************%
\def\tud@file@version{1.0}
\def\tud@file@date{2012/10/31}
\def\tud@file@author{Falk Hanisch}
\def\tud@file@mail{falk.hanisch@gmx.de}
\def\tud@file@name{tudscrbase.sty}

\typeout{Dresden University of Technology CD-Template based on KOMA-Script}
\typeout{Version: \tud@file@version}
\typeout{Date: \tud@file@date}
\typeout{Author: \tud@file@author}

\NeedsTeXFormat{LaTeX2e}
% Ablaufkontrolle
\RequirePackage{etoolbox}
\RequirePackage{calc}

% Einbindung des TUD-Logos
\RequirePackage{graphicx}
% automatische Berechnung der Spaltenbreite, notwendig für TUD-Kopfzeile
\RequirePackage{tabularx}
% Makro \MakeTextUppercase für DIN-Bold-Überschriften
\RequirePackage{textcase}
% abstract-Umgebung neu definieren
\RequirePackage{environ}
\RequirePackage{multicol}

%*******************************************************************************%
%****** Nutzerdaten/Formularfelder *********************************************%
%*******************************************************************************%
% Möglichkeit für die Verwendung des isodate-packages zur Datumsausgabe
\providecommand*{\printdate}[1]{#1}

% Fakultät
\newcommand*{\faculty}[1]{\gdef\@faculty{#1}}
\faculty{}
% Einrichtung
\newcommand*{\department}[1]{\gdef\@department{#1}}
\department{}
% Institut
\newcommand*{\institute}[1]{\gdef\@institute{#1}}
\institute{}
% Lehrstuhl
\newcommand*{\chair}[1]{\gdef\@chair{#1}}
\chair{}%
\let\professorship\chair%
% Ort
\newcommand*{\location}[1]{\gdef\@location{#1}}
\location{Dresden}%
% Geburtsdatum
\newcommand*{\dateofbirth}[1]{\gdef\@dateofbirth{\printdate{#1}}}
\gdef\@dateofbirth{}%
\let\birthday\dateofbirth%
% Geburtsort
\newcommand*{\placeofbirth}[1]{\gdef\@placeofbirth{#1}}
\placeofbirth{}%
\let\birthplace\placeofbirth%
% Studiengang
\newcommand*{\course}[1]{\gdef\@course{#1}}
\course{}%
\let\discipline\course%
% Studienrichtung/Fachrichtung
\newcommand*{\branch}[1]{\gdef\@branch{#1}}
\branch{}%
% zusätzliches feld für alle möglichen Eintragungen 
\newcommand*{\moreauthor}[1]{\def\@moreauthor{#1}}
\moreauthor{}%
% Matrikelnummer 
\newcommand*{\studentid}[1]{\gdef\@studentid{#1}}
\studentid{}%
\let\matriculationnumber\studentid
% Immatrikulationsjahr 
\newcommand*{\enrolmentyear}[1]{\gdef\@enrolmentyear{#1}}
\enrolmentyear{}%
% Art/Typ der Arbeit 
\newif\if@dissertation%
\newcommand*{\thesis}[1]{%
	\gdef\@thesis{#1}%
	\if@atdocument%
		\ifstr{#1}{\dissertationname}{\@dissertationtrue}{}%
	\else%
		\AtBeginDocument{\ifstr{#1}{\dissertationname}{\@dissertationtrue}{}}%
	\fi%
	\if@titlepage\else%
		\ClassWarning{\tud@classname}{%
			\string\thesis\space has to be used with titlepage=on\MessageBreak%
		}%
	\fi%
}%
\gdef\@thesis{}%
%  Schalterfür Dissertation
\newcommand*{\dissertation}{\@dissertationtrue\thesis{\dissertationname}}%
% Abschluss/ akademischer Grad (optional Kurzform) 
\newcommand*{\degree}[2][\@empty]{%
	\ifx#1\@empty\gdef\@degreeadd{}\else\gdef\@degreeadd{(#1)}\fi%
	\gdef\@degree{#2}%
}%
\degree{}%
% Betreuer 1
\newcommand*{\supervisor}[1]{\gdef\@supervisor{#1}}
\supervisor{}%
\let\advisor\supervisor%
% Betreuer 2 
\newcommand*{\supervisorII}[1]{\gdef\@supervisorII{#1}}
\supervisorII{}%
\let\advisorII\supervisorII%
% verantwortlicher Hochschullehrer 
\newcommand*{\professor}[1]{\gdef\@professor{#1}}
\professor{}
% Vorsitzender Prüfungsausschuss 
\newcommand*{\chairman}[1]{\gdef\@chairman{#1}}
\chairman{}
% Anfangsdatum 
\newcommand*{\startdate}[1]{\gdef\@startdate{\printdate{#1}}}
\gdef\@startdate{}
% Enddatum 
\newcommand*{\duedate}[1]{\gdef\@duedate{\printdate{#1}}}
\gdef\@duedate{}
\let\enddate\duedate
% Abgabedatum (standardmäßig Enddatum) 
\newcommand*{\submissiondate}[2][\@empty]{%
	\gdef\@submissionlate{\ifx#1\@empty\else\space#1\fi}%
	\gdef\@submissiondate{\printdate{#2}}%
}%
\let\submitdate\submissiondate%
\gdef\@submissionlate{}%
\gdef\@submissiondate{%
	\ifx\@duedate\@empty%
		\ClassWarningNoLine{\tud@classname}{%
			\string\submissiondate\space was not given.\MessageBreak%
			It's substituted by today's date.\MessageBreak%
		}%
		\today%
	\else%
		\@duedate
	\fi
}
% Verteidigungsdatum
\newcommand*{\defensedate}[1]{\gdef\@defensedate{\printdate{#1}}}
\gdef\@defensedate{}

% Spaltenbreite für Tabelle der Titelseite und Aufgabenstellung
\newlength{\titlecolwidth}\setlength{\titlecolwidth}{-1pt}
\newlength{\taskcolwidth}\setlength{\taskcolwidth}{-1pt}
% vertikale Verschiebung der Überschriften auf Titel/Part/Chapterpage im CD
\newlength{\headingsvskip}%
% Höhe/Platz für Unterschriften
\newlength{\signatureheight}
\setlength{\signatureheight}{25mm minus 15mm}

% Farben des CD der TUD
\RequirePackage{tudscrcolor}%
% sprachspezifische Bezeichner und Texte
\RequirePackage{tudscrlocale}%

%*******************************************************************************%
%****** Einstellung der Größen der Kopfzeile und der Seitenränder **************%
%*******************************************************************************%
% Einstellungen für Ränder und Größe der Kopfzeile nach CD
% CD wird für typearea-Satzspiegelkonstruktion nicht exakt übernommen
% Höhe über Querbalken
\newlength{\tud@head@dimA}\setlength{\tud@head@dimA}{35mm}
% Höhe Querbalken
\newlength{\tud@head@dimB}\setlength{\tud@head@dimB}{5mm}
% (Mindest-)Abstand Querbalken und Textkörper
\newlength{\tud@head@sep}\setlength{\tud@head@sep}{12mm}
% horizontaler (Soll-)Abstand Rand und Text
\newlength{\tud@head@dist}\setlength{\tud@head@dist}{30mm}
% Schriftgröße Querbalken in pt
\def\tud@head@fntsz{9}
% Liniendicke des Querbalkens weiße Seite
\newlength{\tud@head@lwA}\setlength{\tud@head@lwA}{0.5pt}
% Liniendicke des Querbalkens farbige Seite
\newlength{\tud@head@lwB}\setlength{\tud@head@lwB}{1pt}
% TUD-Logo
% horizontaler (Soll-)Abstand Rand und Logo
\newlength{\tud@logo@x}\setlength{\tud@logo@x}{11mm}
% vertikaler (Soll-)Abstand Rand und Logo
\newlength{\tud@logo@y}\setlength{\tud@logo@y}{13.5mm}
% Breite des gesamten Logos
\newlength{\tud@logo@w}\setlength{\tud@logo@w}{57mm}
% Höhe des DDC-Logos
\newlength{\tud@logo@ddch}\setlength{\tud@logo@ddch}{25mm}
% temporäre Länge
\newlength{\@tud@dimtemp}%

%*******************************************************************************%
%****** CD-Schriften verfügbar machen ******************************************%
%*******************************************************************************%
% Kommandos für Setzen ausgewählter Text in spezieller Schrift
% Univers 45 Light
\newcommand*{\univln}{\usefont{T1}{aun}{l}{n}}
% Univers 55 Regular
\newcommand*{\univrn}{\usefont{T1}{aun}{m}{n}}
% Univers 65 Bold
\newcommand*{\univbn}{\usefont{T1}{aun}{b}{n}}
% Univers 75 Black
\newcommand*{\univxn}{\usefont{T1}{aub}{m}{n}}
% Univers 45 Light Oblique
\newcommand*{\univls}{\usefont{T1}{aun}{l}{sl}}
% Univers 55 Regular Oblique
\newcommand*{\univrs}{\usefont{T1}{aun}{m}{sl}}
% Univers 65 Bold Oblique
\newcommand*{\univbs}{\usefont{T1}{aun}{b}{sl}}
% Univers 75 Black Oblique
\newcommand*{\univxs}{\usefont{T1}{aub}{m}{sl}}
% FF DIN Bold
\newcommand*{\dinbn}{\usefont{T1}{din}{b}{n}\tud@ragged}
\DeclareTextFontCommand{\textuln}{\univln}
\DeclareTextFontCommand{\texturn}{\univrn}
\DeclareTextFontCommand{\textubn}{\univbn}
\DeclareTextFontCommand{\textuxn}{\univxn}
\DeclareTextFontCommand{\textuls}{\univls}
\DeclareTextFontCommand{\texturs}{\univrs}
\DeclareTextFontCommand{\textubs}{\univbs}
\DeclareTextFontCommand{\textuxs}{\univxs}
\DeclareTextFontCommand{\textdbn}{\dinbn}
% keine Silbentrennung in Überschriften
\newcommand*{\tud@ragged}{\raggedright}
% Prüfen, ob Standardbefehle überschrieben wurden
\AfterPackage!{ragged2e}{%
	\ifdef{\LaTeXraggedright}{\renewcommand*{\tud@ragged}{\LaTeXraggedright}}{}
}
%****** Kompatibilität zu setspace-package *************************************%
% Überschriften nur einzeilig setzen
\AfterPackage!{setspace}{%
	\addtokomafont{disposition}{\setstretch{\setspace@singlespace}}%
}%

%*******************************************************************************%
%****** Seitenstil im CD der TUD ***********************************************%
%*******************************************************************************%
% Schriften für Kopfzeile
\newif\if@tud@headfont%
\DeclareFixedFont{\BoldHead}{T1}{\sfdefault}{bx}{n}{\tud@head@fntsz}
\DeclareFixedFont{\LightHead}{T1}{\sfdefault}{m}{n}{\tud@head@fntsz}
\DeclareFixedFont{\univLightHead}{T1}{aun}{l}{n}{\tud@head@fntsz}
\DeclareFixedFont{\univBoldHead}{T1}{aun}{b}{n}{\tud@head@fntsz}
% Längen für Verschiebung der Tabelle und des Logos in Kopfzeile
\newlength{\tud@head@tbloff}
\newlength{\tud@logo@xoff}
\newlength{\tud@logo@yoff}
% Längen zum Ausgleich des Satzspiegels für normale Seiten und CD-Seiten
\newlength{\tud@head@scr}
\newlength{\tud@head@tudscr}
\newlength{\tud@head@diff}
\newlength{\tud@foot@diff}
% Berechnung des Unterschiedes zwischen normaler und TUD-Kopfzeile
\def\tud@head@calc{%
	\setlength{\tud@head@scr}{1in+\topmargin+\headheight+\headsep}%
	\setlength{\tud@head@tudscr}{\tud@head@dimA+\tud@head@dimB+\tud@head@sep}%
	\setlength{\tud@head@diff}{\tud@head@tudscr-\tud@head@scr}%
}
% Text der Kopfzeile via Bufferstring
% Länge zum Prüfen der Breite der ersten Zeile im Kopf
\newlength{\tud@head@w}%
% Schalter für evtl. notwendige zweite Zeile
\newif\if@hl@wrtlnB%
% Breite der Linie der Kopfzeile, standardmäßig schmal
\newlength{\tud@head@lw}\setlength{\tud@head@lw}{\tud@head@lwA}%
% Farbe des Kopfes (Logo, Linien, Schrift)
\gdef\tud@head@color{black}%
% normaler/plain TUD-Seitenstil
\def\ps@tudpage{\tud@page}%
\def\ps@@tudpage{\ps@empty\tud@page}%
% Definition der Seite selbst
\def\tud@page{%
	% Ränder für spezielle Seite setzen
	\tud@head@calc
	% keinen Rand nach oben durch Abzug des Standardrandes von 1in
	\setlength{\topmargin}{-1in}%
	\setlength{\headheight}{\tud@head@dimA+\tud@head@dimB}%
	\setlength{\headsep}{\tud@head@sep}%
	% Anfangshöhe des Textes beachten,
	% falls auf normalen Seiten der Text tiefer als hier beginnt
	\ifdim\tud@head@diff<0pt\relax%
		\addtolength{\headsep}{-\tud@head@diff}%
	\fi%
	% erste Zeile
	\def\tud@head@textA{}%
	% zweite Zeile
	\def\tud@head@textB{}%
	% Buffer für Delimeter
	\def\tud@head@delbuf{}%
	% Toleranzparameter für Warnungen anpassen
	\hbadness=10000%
	% Logo und Querbalken setzen
	\renewcommand*{\@oddhead}{%
		\color{\tud@head@color}%
		\ifx\@faculty\@empty%
			\ClassWarningNoLine{\tud@classname}{%
				There was no faculty given.\MessageBreak%
			}%
			\faculty{\null}%
		\fi%
		\let\tud@boldhead\univBoldHead%
		\let\tud@lighthead\univLightHead%
		\if@tud@tudfonts\else\if@tud@headfont\else%
			\let\tud@boldhead\BoldHead%
			\let\tud@lighthead\LightHead%
		\fi\fi%
		\tud@head@add[\ ]{\tud@boldhead}{\@faculty}%
		\tud@head@add{\tud@lighthead}{\@department}%
		\tud@head@add{\tud@lighthead}{\@institute}%
		\tud@head@add{\tud@lighthead}{\@chair}%
		% Verschiebung des Kopfes in den Satzspiegel
		\setlength{\tud@head@tbloff}{\oddsidemargin}%
		\ifodd\c@page\else\if@twoside%
			\setlength{\tud@head@tbloff}{\evensidemargin}%
		\fi\fi%
		\addtolength{\tud@head@tbloff}{1in}%
		\hspace*{-\tud@head@tbloff}%
		% Verschiebung des Kopfes, dass TU-Logo aus dem Satzspiegel herausragt
		\setlength{\tud@logo@xoff}{\tud@head@tbloff-\tud@head@dist+\tud@logo@x}%
		% Verschiebung des Kopfes, dass TU-Logo auf der richtigen Höhe ist
		\setlength{\tud@logo@yoff}{\tud@head@dimA-\tud@logo@y-\tud@logo@h}%
		\addtolength{\tud@logo@yoff}{-\tud@head@lw}%
		% Auswahl der Weite der Kopfzeile
		\setlength{\arrayrulewidth}{\tud@head@lw}%
		\if@tud@widehead%
			% volle Blattbreite
			\def\tud@head@hl{\hline}%
		\else%
			% Satzspiegelbreite
			\def\tud@head@hl{%
				\noalign{\vspace*{.25\tud@head@lw}}%
				\cline{2-2}%
				\noalign{\vspace*{.75\tud@head@lw}}%
			}%
		\fi%
		% Schriftzeile des Kopfes nur so hoch, wie zu schreibender Text
		\renewcommand*{\baselinestretch}{0}\normalsize%
		% vertikale Abstände innerhalb der Tabelle löschen
		% Kopf mit Tabelle setzen
		\begin{tabularx}{\paperwidth}[b]%
			{@{}p{\tud@head@tbloff}@{}@{}p{\textwidth}@{}@{}X@{}}%
			% TUD-Logo
			\setlength{\@tud@dimtemp}{%
				\tud@logo@w-\tud@head@tbloff+\tud@logo@xoff+0.1pt%
			}%
			\hfuzz=\@tud@dimtemp % Warnung unterdrücken
			% TUD-Logo und evtl. zweites Logo setzen
			\hspace*{\tud@logo@xoff}\tud@logo
				& \hfill\tud@logoB\tabularnewline[\tud@logo@yoff]%
			\tud@head@hl%
			% erste Kopfzeile ausgeben
			& \tud@head@write{\tud@head@textA}\tabularnewline%
			\tud@head@hl%
		\end{tabularx}%
		% zweite Kopfzeile ausgeben
		\hspace{-\paperwidth}\hspace{\tud@head@tbloff}%
		\tud@head@write[t]{\vspace{\tud@head@lw}\tud@head@textB}%
	}%
	\let\@evenhead\@oddhead%	
	% Makros für die Speicherung und Ausgabe der Kopfzeilen A und B
	% (Überschreiben für evtl unterschiedliche Linienbreiten notwendig)
	% Befüllen der Kopfzeilen A und B
	\let\tud@head@add\relax%
	\newcommand*{\tud@head@add}[3][, ]{%
		\def\@hl@font{##2}%
		\edef\@hl@strg{##3}%
		% Auswahl des entsprechenden Trennzeichens
		\ifx\@hl@strg\@empty%
			% kein Argument, kein Trennzeichen
			\def\@hl@delim{}%
		\else%
			% Trennzeichen aus Puffer, folgendes Trennzeichen in Puffer
			\edef\@hl@delim{\tud@head@delbuf}%
			\def\tud@head@delbuf{##1}%
		\fi%
		\if@hl@wrtlnB\else%
			% temporärer String zum Prüfen der Zeilenbreite
			\def\tud@head@temp{\tud@head@textA\@hl@delim\@hl@font\@hl@strg}%
			\settowidth{\tud@head@w}{\tud@head@temp}%
			% Kopfzeile breiter als Textbreite --> neue Zeile, kein Trennzeichen
			\ifdim\tud@head@w>\textwidth%
				\@hl@wrtlnBtrue%
				\def\@hl@delim{}%
			\else%
				\edef\tud@head@textA{\tud@head@temp}%
			\fi%
		\fi%
		\if@hl@wrtlnB%
			\edef\tud@head@textB{\tud@head@textB\@hl@delim\@hl@font\@hl@strg}%
		\fi%
	}%
	% Ausgabe der Kopfzeilen A und B
	\let\tud@head@write\relax%
	\newcommand*{\tud@head@write}[2][c]{%
		\parbox[##1][\tud@head@dimB-\tud@head@lw][c]{\textwidth}%
			{\vspace*{1\tud@head@lw}\tud@ragged##2}%
	}
}%
% Einbinden des Logos der TUD
\def\tud@logo{%
	\def\tud@logo@file{TU_Logo_SW}%
	\ifpdfoutput{}{%
		\ifstr{\tud@head@color}{HKS41}{\def\tud@logo@file{TU_Logo_HKS41}}{}%
		\ifstr{\tud@head@color}{white}{\def\tud@logo@file{TU_Logo_WS}}{}%
	}%
	\includegraphics[width=\tud@logo@w]{\tud@logo@file}
}
% Höhe des gesamten Logos
\newlength{\tud@logo@h}\settoheight{\tud@logo@h}{\tud@logo}
% zusätzliches Logo im Kopf (rechts, standardmäßig gleiche Höhe wie TU-Logo)
\newcommand*{\logofile}[2][\@empty]{%
	\ifstrempty{#2}{\def\tud@logoB{}}{%
		\def\tud@logoB{%
			\ifx#1\@empty%
				\includegraphics[height=\tud@logo@h]{#2}%
			\else%
				\includegraphics[#1]{#2}%
			\fi%
		}%
	}%
}%
\logofile{}%

% Wechsel zum TUD-Seitenstil erfordert zwingend einen Seitenumbruch
% (Änderung der Texthöhe für unterschiedliche Satzspiegel der beiden Seitenstile)
% Befehl zum Setzen des Satzspiegels für tudpage
\let\tud@activateareas\activateareas%
% Warnung entfernen §§§ dreckiger Hack
\patchcmd{\tud@activateareas}{\PackageWarning{typearea}{%
	Typearea changed!\MessageBreak
	You should do this only at preamble, because only\MessageBreak
	\protect\begin{document} calculates output dimensions!\MessageBreak
	Trying to calculate new output dimensions, but\MessageBreak
	this is only a dirty hack}}{}{}%
	{%
		\ClassWarning{\tud@classname}{%
			\string\activateareas\space has changed. Please contact\MessageBreak
			the author of this class via\MessageBreak\tud@file@mail\MessageBreak
		}%
	}%
% Umschalten und Neuberechnung des Satzspiegels (für Titel- und Partseiten)
\def\tud@areaset{%
	\tud@head@calc%
	\addtolength{\textheight}{-\tud@head@diff}%
	\tud@activateareas%
	\addtolength{\textheight}{\tud@head@diff}%
}
% Textsatz im TUD-Seitenlayout muss in entsprechende environment
% (tudpage, optionales Argument für Kopffarbe, Zweitlogo und Fußzeile)
\define@key{tudpage}{color}{\renewcommand*{\tud@head@color}{#1}}%
\define@key{tudpage}{head}{%
	\ifstr{#1}{none}{\logofile{}}{%
	\ifstr{#1}{ddc}{\TUDoptions{ddc}\tud@page@ddchead}{%
	\ifstr{#1}{ddccolor}{\TUDoptions{ddc=color}\tud@page@ddchead}{%
	\ifstr{#1}{logo}{}{%
	\tud@page@err{head}{none,ddc,ddccolor,logo}
	}}}}%
}%
\newif\if@tud@page@foot
\define@key{tudpage}{foot}{%
	\ifstr{#1}{plain}{}{%
	\ifstr{#1}{empty}{\renewcommand*{\@oddfoot}{}\let\@evenfoot\@oddfoot}{%
	\ifstr{#1}{ddc}{\tud@page@ddcfoot{false}}{%
	\ifstr{#1}{ddccolor}{\tud@page@ddcfoot{true}}{%
	\tud@page@err{foot}{plain,empty,ddc,ddccolor}
	}}}}%
}%
\define@key{tudpage}{tudfonts}[true]{%
	\ifstr{#1}{true}{\def\@tempa{true}}{%
	\ifstr{#1}{on}{\def\@tempa{true}}{%
	\ifstr{#1}{yes}{\def\@tempa{true}}{%
	\ifstr{#1}{false}{\def\@tempa{false}}{%
	\ifstr{#1}{no}{\def\@tempa{false}}{%
	\ifstr{#1}{off}{\def\@tempa{false}}{%
	\tud@page@err{tudfonts}{true,on,yes,false,off,no}
	}}}}}}
	\csname @tud@headfont\@tempa\endcsname
}

\newcommand*{\tud@page@err}[2]{%
	\ClassError{\tud@classname}{Undefined option for tudpage}{%
		Key '#1' can only be used with these values:\MessageBreak#2%
	}%
}%
\newenvironment{tudpage}[1][]{%
	\setkeys{tudpage}{#1}%
	\clearpage%
	\tud@head@calc%
	\if@tud@page@foot%
		% Berechnung der vorhandenen Höhe für Fuß in \tud@foot@diff
		\setlength{\tud@foot@diff}{\paperheight}%
		\addtolength{\tud@foot@diff}{-\textheight}%
		\addtolength{\tud@foot@diff}{-\topmargin}%
		\addtolength{\tud@foot@diff}{-\headheight}%
		\addtolength{\tud@foot@diff}{-\headsep}%
		\addtolength{\tud@foot@diff}{-\topskip}%
		\addtolength{\tud@foot@diff}{-\footskip}%
		\addtolength{\tud@foot@diff}{-\tud@head@diff}%
		% Differenz zw vorhadener und notwendiger
		\addtolength{\tud@foot@diff}{-\tud@logo@ddch}%
		\ifdim\tud@foot@diff<0pt\relax%
			\addtolength{\textheight}{\tud@foot@diff}
		\fi%
	\fi%
	\addtolength{\textheight}{-\tud@head@diff}%
	\setlength{\@tud@dimtemp}{\tud@head@diff}%
	\tud@activateareas%
	\pagestyle{tudpage}%
	\ifartcl{}{%
		\renewcommand*{\chapterpagestyle}{tudpage}%
		\if@tud@chapterpage%
			\ifstr{\partpagestyle}{empty}%
				{\renewcommand*{\chapterpagestyle}{@tudpage}}%
				{}%
		\fi%
	}%
}{%
	\addtolength{\textheight}{\the\@tud@dimtemp}%
	\addtolength{\textheight}{-\tud@foot@diff}%
	\clearpage%	
}%
\newcommand{\tud@page@ddchead}{%
	\def\tud@logoB{%
		\def\tud@logo@file{\includegraphics[height=\tud@logo@h]}%
		\ifnum\@tud@ddc=2%
			\tud@logo@file{DDC-09}%
		\else%
			\ifstr{\tud@head@color}{HKS41}{\tud@logo@file{DDC-27}}{%
			\ifstr{\tud@head@color}{cddarkblue}{\tud@logo@file{DDC-27}}{%
			\ifstr{\tud@head@color}{white}{\tud@logo@file{DDC-30}}{%
				\tud@logo@file{DDC-24}%
			}}}%
		\fi%
	}%
}%
\newcommand{\tud@page@ddcfoot}[1]{%
	\@tud@page@foottrue
	\def\tud@logofoot{%
		\def\tud@logo@file{\includegraphics[height=\tud@logo@ddch]}%
		\ifstr{#1}{true}{\tud@logo@file{DDC-07}}{%
			\ifstr{\tud@head@color}{HKS41}{\tud@logo@file{DDC-25}}{%
			\ifstr{\tud@head@color}{cddarkblue}{\tud@logo@file{DDC-25}}{%
			\ifstr{\tud@head@color}{white}{\tud@logo@file{DDC-28}}{%
				\tud@logo@file{DDC-22}%
			}}}%
		}%
	}%
	\renewcommand*{\@oddfoot}{\parbox{\textwidth}{%
		\vspace*{\footskip}%
		\vspace*{-\baselineskip}%
		\hfill\tud@logofoot%
	}}%
	\let\@evenfoot\@oddfoot%
}%

%*******************************************************************************%
%****** Titelseiten in verschiedenen Stilen ************************************%
%*******************************************************************************%
% Titelseiten einbinden
\RequirePackage{tudscrtitle}

%*******************************************************************************%
%****** Aufgabenstellung *******************************************************%
%*******************************************************************************%
% Umgebung für eine Aufgabenstellung
\newenvironment{task}[1][]{%
	\ifx\@thesis\@empty%
		\ClassError{\tud@classname}{No \string\thesis\space given}{%
			The command \string\task\space is not defined\MessageBreak
			due the absence of a specified thesis.\MessageBreak
			Use \string\thesis{}\space command to define a thesis,\MessageBreak
			e.g. \string\thesis{Master Thesis}
		}
	\fi%
	\if@dissertation%
		\ClassWarningNoLine{\tud@classname}{%
			Using the command \string\task\space is not recommended\MessageBreak
			for a dissertation thesis.\MessageBreak
		}
	\fi%
	\cleardoubleoddpage%
	\@addbookmark{\taskname}%
	\ifstr{\tud@lyt@task}{lite}%
		{\renewcommand*{\tud@head@color}{HKS41}}%
		{\renewcommand*{\tud@head@color}{black}}%
	\begin{tudpage}[foot=empty,#1]
	% Formatierung der Überschrift
	\if@tud@tudfonts%
		\ifstr{\tud@lyt@task}{no}{%
			\sect@reset{subsection}%
			\sect@reset{minisec}%
		}{}%
	\else%
		\ifstr{\tud@lyt@task}{no}{%
			\sect@reset{subsection}%
			\sect@reset{minisec}%
		}{%
			\TUDoptions{tudfonts}%
			\setkeys{tudpage}{tudfonts}%
		}%
	\fi%
	\subsection*{%
		\taskname\space%
		\ifx\tasktext\@empty\else\ignorespaces\tasktext\unskip\space\@thesis\fi%
	}%
	% Variation Kopf mit einfacher oder zweifacher Spalte
	\ifdim\taskcolwidth<0pt\relax\@setcoltask\fi%
	\begingroup%
	\setlength{\parindent}{\z@}\setlength{\parfillskip}{\fill}%
	% Zweifachspalte
	\if@tud@comptask%
		\gdef\tud@stra{}\gdef\tud@strb{}\gdef\tud@strc{}%
		\newcommand*{\@calccol}{%
			\setlength{\hsize}{2\hsize+\taskcolwidth+4\tabcolsep}%
		}%
		\newcommand*{\@setstr}[2]{%
			\def\strbr{\branchname\titlecoldelim & \@branch}%
			\def\strey{\enrolmentname\titlecoldelim & \@enrolmentyear}%
			\def\strid{\studentidname\titlecoldelim & \@studentid}%
			\expandafter\xdef\csname tud@str##1\endcsname{%
				\ifcase##2\strbr\or\strey\or\strid\else\strid & \strey\fi%
			}%
		}%
		\begin{tabularx}{\textwidth}{@{}p{\taskcolwidth}Xp{\taskcolwidth}X@{}}%
			\ifdefempty{\@branch}{%
				\ifdefempty{\@enrolmentyear}%
					{\ifdefempty{\@studentid}{}{\@setstr{a}{2}}}
					{\@setstr{a}{1}\ifdefempty{\@studentid}{}{\@setstr{b}{2}}}
			}{%
				\@setstr{a}{0}
				\ifdefempty{\@enrolmentyear}
					{\ifdefempty{\@studentid}{}{\@setstr{b}{2}}}
					{\ifdefempty{\@studentid}{\@setstr{b}{1}}{\@setstr{c}{3}}}
			}
			% erste Zeile
			\ifdefempty{\@course}{}{\coursename\titlecoldelim & \@course
				& \tud@stra\tabularnewline}
			% zweite Zeile
			\authorname\titlecoldelim & \textbf{\sffamily\@author}
				& \tud@strb\tabularnewline%
			% evtl dritte Zeile
			\ifdefempty{\tud@strc}{}{\tud@strc\tabularnewline}
			% Titelzeile
			\tabularnewline[-\ht\strutbox]%
			\titlename\titlecoldelim & %
				\multicolumn{3}{>{\@calccol}X@{}}%
					{\textsf{\textbf{\@title}}}%
				\tabularnewline%
		\end{tabularx}%
	% Einzelspalte
	\else%
		\begin{tabularx}{\textwidth}{@{}p{\taskcolwidth}X@{}}
			\ifx\@course\@empty\else%
				\coursename\titlecoldelim & \@course\tabularnewline%
				\ifx\@branch\@empty\else\branchname\titlecoldelim
					& \@branch\tabularnewline\fi%
			\fi%
			\authorname\titlecoldelim
				& \textbf{\sffamily\@author}\tabularnewline%
			\ifx\@studentid\@empty\else\studentidname\titlecoldelim
				& \@studentid\tabularnewline\fi%
			\ifx\@enrolmentyear\@empty\else\enrolmentname\titlecoldelim
				& \@enrolmentyear\tabularnewline\fi%
			\tabularnewline[-\ht\strutbox]%
			\titlename\titlecoldelim & \textsf{\textbf{\@title}}%
		\end{tabularx}%
	\fi\par\null\endgroup%
}{%
	\begingroup%
	\setlength{\parindent}{\z@}\setlength{\parfillskip}{\fill}\par\null%
	\begin{tabularx}{\textwidth}{@{}p{\taskcolwidth}X@{}}
		\supervisorname\titlecoldelim & \@supervisor\tabularnewline
		\ifx\@supervisorII\@empty\else%
			\ifstr{\supervisorIIname}{}{}{\supervisorIIname\titlecoldelim}%
			& \@supervisorII\tabularnewline%
		\fi%
		\tabularnewline[-\ht\strutbox]%
		\starttext\titlecoldelim & \@startdate\tabularnewline%
		\duetext\titlecoldelim & \@duedate\tabularnewline%
	\end{tabularx}%
	\parskip0pt\par\vspace*{\signatureheight}%
	\begin{tabularx}{\textwidth}{@{}lXl@{}}%
		\ifx\@chairman\@empty%
			\@professor\tabularnewline%
			\professorname\tabularnewline%
		\else%
			\@chairman & & \@professor\tabularnewline%
			\chairmanname & & \professorname\tabularnewline%
		\fi%
	\end{tabularx}%
	\endgroup%
	\end{tudpage}%
	\if@twoside\cleardoubleoddpage\fi%
}

% Standardform für Aufgabenstellung
\newcommand*{\tasks}[3][]{%
	\task[#1]
	\ifx#2\@empty\else%
		\minisec{\objectivestext}
		#2%
	\fi%
	\ifx#3\@empty\else%
		\minisec{\focustext}
		#3%
	\fi%
	\endtask%
}

% Setzen der Spaltenbreiten für Aufgabenstellung
\newcommand*{\@setcoltask}{%
	\@setcolwidth{\taskcolwidth}{\authorname}%
	\ifx\@course\@empty\else\@setcolwidth{\taskcolwidth}{\coursename}\fi%
	\ifx\@branch\@empty\else\@setcolwidth{\taskcolwidth}{\branchname}\fi%
	\ifx\@studentid\@empty\else\@setcolwidth{\taskcolwidth}{\studentidname}\fi%
	\ifx\@enrolmentyear\@empty\else%
		\@setcolwidth{\taskcolwidth}{\enrolmentname}%
	\fi
	\ifx\@supervisor\@empty\else\@setcolwidth{\taskcolwidth}{\supervisorname}\fi%
	\ifx\@supervisorII\@empty\else%
		\ifstr{\supervisorIIname}{}
			{}{\@setcolwidth{\taskcolwidth}{\supervisorIIname}}%
	\fi%	
	\@setcolwidth{\taskcolwidth}{\starttext}
	\@setcolwidth{\taskcolwidth}{\duetext}
	% Standardbreiten
	\ifdim\taskcolwidth=0em\relax\setlength{\taskcolwidth}{6em}\fi%
}

%*******************************************************************************%
%****** Kurzfassung/Abstract ***************************************************%
%*******************************************************************************%
% neue Varainte
\newcommand*{\@abstract}[1]{%
	\def\@abstracthead{%
		\if@tud@abstrchap
			\if@tud@abstrtoc%
				\addchap{\abstractname}%
			\else%
				\addchap*{\abstractname}%
			\fi%
		\else
			\if@tud@abstrtoc%
				\ifartcl
					{\addsec{\abstractname}}
					{%
						\addsec*{\abstractname}%
						\addchaptertocentry{}{\abstractname}%
					}%
			\else%
				\addsec*{\abstractname}%
			\fi%
		\fi%
	}%
	\def\@abstracttext{%
		\ifx#1\@empty\else\selectlanguage{#1}\fi%
		\@abstracthead%
		\if@titlepage\thispagestyle{empty}\fi%
		\BODY%
	}%
	\if@titlepage%
		\ifboolexpr{bool {@tud@abstrdbl} and %
			not (bool {@tud@chapterpage} and bool {@tud@abstrchap})}%
		{%
			\if@twocolumn%
				\def\@abstracttext{%
					\ifx#1\@empty\else\selectlanguage{#1}\fi%
					\if@tud@abstrchap%
						\vspace*{-0.15ex}% §§§ Hack
						\chapterheadstartvskip%
						\begingroup%
						\usekomafont{chapter}%
						\vspace*{-\parskip}%
						\MakeTextUppercase{\abstractname}%
						\endgroup%
						\chapterheadendvskip%
						\par%
					\else%
						\if@tud@abstrtoc%
							\ifartcl
								{\addsec{\abstractname}}
								{%
									\addsec*{\abstractname}%
									\addchaptertocentry{}{\abstractname}%
								}%
						\else%
							\addsec*{\abstractname}%
						\fi%
					\fi%
					\noindent%
					\begin{minipage}[t]{\textwidth}%
					\KOMAoptions{parskip=\@tud@parskip}\selectfont%
					\thispagestyle{empty}%
					\vspace*{-\baselineskip}\vspace*{-\parskip}%
					\begin{multicols}{2}%
					\BODY%
					\end{multicols}%
					\end{minipage}%
				}%
				\@checkandwrite{\@abstracttext}%
			\else%
				\@checkandwrite{\@abstracttext}%
			\fi%
		}{%
			\if@tud@abstrchap%
				\@abstracttext%
			\else%
				\if@twocolumn%
					\@abstracttext%
				\else%
					\null\vfill%
					\@abstracttext%
					\par\vfill\vfill\null\clearpage%
				\fi%
			\fi%
		}%
	\else%
		\@abstracttext%
	\fi%
}%
% angepasste alte Variante
\newcommand*{\@@abstract}[1]{%
	\def\@abstracttext{%
		\ifx#1\@empty\else\selectlanguage{#1}\fi%
		\if@tud@abstrtoc
			\phantomsection%
			\ifartcl%
				{\addsectiontocentry{}}%
				{\addchaptertocentry{}}{\abstractname}%
		\fi
		\tud@ori@abstract%
		\BODY%
		\tud@ori@endabstract%
	}%
	\ifboolexpr{bool {@tud@abstrdbl} and bool {@titlepage}}
		{\@checkandwrite{%
			\begin{minipage}{\textwidth}%
			\@abstracttext%
			\end{minipage}%
			\setlength{\parfillskip}{\fill}%
		}\par}%
		{\@abstracttext}%
}

%*******************************************************************************%
%****** Selbstständigkeitserklärung und Sperrvermerk ***************************%
%*******************************************************************************%
\def\@confirmation{%
	\ifartcl{\section*{\confirmationname}}{\chapter*{\confirmationname}}%
	\confirmationtext%
	\vskip\z@\medskip%
	\noindent\@location, \@submissiondate%
	\vskip\signatureheight%
	\noindent\@author%
}%
\def\@restriction{%
	\ifartcl{\section*{\restrictionname}}{\chapter*{\restrictionname}}%
	\restrictiontext%
}
% Befehl für Selbstständigkeitserklärung
\newcommand*{\confirmation}{%
	\begingroup%
	\ifartcl{\thispagestyle{empty}}{\renewcommand*{\chapterpagestyle}{empty}}
	\@confirmation%
	\endgroup%
}
% Befehl für Sperrvermerk
\newcommand*{\restriction}[1][\@empty]{%
	\ifx#1\@empty\else\gdef\@restrictioncompany{#1}\fi%
	\begingroup%
	\ifartcl{\thispagestyle{empty}}{\renewcommand*{\chapterpagestyle}{empty}}
	\@restriction%
	\endgroup%
}%
% Befehl für Selbstständigkeitserklärung und Sperrvermerk
\newcommand*{\confirmationandrestriction}[1][\@empty]{%
	\ifx#1\@empty\else\gdef\@restrictioncompany{#1}\fi%
	\begingroup%
	\ifartcl{\thispagestyle{empty}}{\renewcommand*{\chapterpagestyle}{empty}}
	\@tud@samepagefalse%
	\@checkandwrite{\@confirmation}%
	\@checkandwrite{\@restriction}%
	\endgroup%
	\global\@tud@samepagefalse%
}%
% Befehl für Sperrvermerk und Selbstständigkeitserklärung
\newcommand*{\restrictionandconfirmation}[1][\@empty]{%
	\begingroup%
	\ifx#1\@empty\else\gdef\@restrictioncompany{#1}\fi%
	\ifartcl{\thispagestyle{empty}}{\renewcommand*{\chapterpagestyle}{empty}}
	\@tud@samepagefalse%
	\@checkandwrite{\@restriction}%
	\@checkandwrite{\@confirmation}%
	\endgroup%
	\global\@tud@samepagefalse%
}%

%*******************************************************************************%
%****** Befehle zur allgemeinen Verwendung (Titelei,etc.) **********************%
%*******************************************************************************%
% Zum Setzen der passenden Spaltenbreite für Titelseite und Task
\newcommand*{\@setcolwidth}[2]{%
	\settowidth{\@tud@dimtemp}{#2\titlecoldelim}
	\ifdim\@tud@dimtemp>#1\relax\setlength{\global#1}{\@tud@dimtemp}\fi%
}

% Befehl zum möglichen Setzen zweier Kapitel auf eine Seite
\newif\if@tud@samepage%
\newcommand*{\@checkandwrite}[1]{%
	\settototalheight{\@tud@dimtemp}{\vtop{#1}}%
	\if@tud@samepage%
		\ifdim\@tud@dimtemp>0.5\textheight\relax%
			\@tud@samepagefalse%
		\fi%
	\fi%
	\if@tud@samepage%
		\vfill\vtop to 0.5\textheight{#1\vfill\null}%
		\global\@tud@samepagefalse\clearpage%
	\else%
		\clearpage#1%
		\ifdim\@tud@dimtemp>0.5\textheight\relax%
			\global\@tud@samepagefalse\clearpage%
		\else
			\global\@tud@samepagetrue%
		\fi
	\fi%
}%

%*******************************************************************************%
%*******************************************************************************%
%****** Klassenoptionen ********************************************************%
%*******************************************************************************%
%*******************************************************************************%

% Behandlung der Klassenoptionen nach Art und Weise des KOMA-Scriptes
\RequirePackage{scrbase}
\DefineFamily{TUD}
\DefineFamilyMember{TUD}
\newcommand*{\TUDoptions}{\FamilyOptions{TUD}}
\newcommand*{\TUDoption}{\FamilyOption{TUD}}

% Befehle, um bei sich beeinflussenden Klassenoptionen die Default-Werte setzen
% zu können aber jederzeit direkt setzbar zu sein
\newcommand*{\FamilyAppBoolKey}[5][.\@currname.\@currext]{%
	\FamilyBoolKey[#1]{#2}{#3}{#4}%
	\expandafter\newif\csname if#4@lock\endcsname%
	\DefineFamilyKey[{#1}]{#2}{#3}[true]{%
		\csname #4@locktrue\endcsname%
		\FamilySetBool{#2}{#3}{#4}{##1}%
		#5%
	}
}
% Befehl zum Default-Wert setzen
\newcommand*{\FamilySetAppBool}[5][.\@currname.\@currext]{%
	\expandafter\csname if#4@lock\endcsname\else%
		\FamilyOption{#2}{#3}{#5}
	\fi%
}
\newcommand*{\LayoutKey}[1]{%
	\@ifundefined{#1}{%
		\expandafter\def\csname#1\endcsname{no}%
	}{}
	\@ifundefined{if@#1@lock}{%
		\expandafter\newif\csname if@#1@lock\endcsname%
	}{}
}
\newcommand*{\SetLayoutDefault}[2]{%
	\expandafter\csname if@#1@lock\endcsname\else%
		\expandafter\def\csname#1\endcsname{#2}%
	\fi
}
\newcommand*{\SetLayout}[2]{%
	\expandafter\def\csname#1\endcsname{#2}%
	\csname @#1@locktrue\endcsname%
}
\newcommand*{\cmd@store}[1]{%
	\@ifundefined{tud@ori@#1}{%
		\expandafter\let\csname tud@ori@#1\expandafter\endcsname%
		\csname #1\endcsname%
	}{}%
}
\newcommand*{\cmd@restore}[1]{%
	\@ifundefined{tud@ori@#1}{}{%
		\expandafter\let\csname #1\expandafter\endcsname%
		\csname tud@ori@#1\endcsname%
	}%
}%
\newif\if@artcl\@ifclassloaded{scrartcl}{\@artcltrue}{}
\def\ifartcl{\ifbool{@artcl}}%

%*******************************************************************************%
%****** Optionen für den Satzspiegel *******************************************%
%****** BCOR, parskip, geometry, headfoot **************************************%
%*******************************************************************************%

%****** Option für Bindekorrektur **********************************************%
\newlength{\@tud@BCOR}
\DefineFamilyKey{TUD}{BCOR}{\setlength{\@tud@BCOR}{#1}\tud@mrg@process}

%****** Option für Absatzeinstellungen *****************************************%
\def\@tud@parskip{no}
\DefineFamilyKey{TUD}{parskip}{\def\@tud@parskip{#1}}

%****** Option für Gestaltungs des Satzspiegels (Seitenränder) *****************%
\def\@tud@geometry{0}
\DefineFamilyKey{TUD}{geometry}[true]{%
	\FamilySetNumerical{TUD}{geometry}{@tud@geometry}{%
		{false}{0},{off}{0},{no}{0},%
		{true}{1},{on}{1},{yes}{1},{tud}{1},{asymmetric}{1},{cd}{1},%
		{symmetric}{2},{normal}{2},{standard}{2},{std}{2}%
	}{#1}%
	\tud@mrg@process%
}

%****** Option für die Behandlung der Kopf- und Fußzeilen **********************%
\newif\if@tud@headinclude%
\DefineFamilyKey{TUD}{headinclude}[true]{%
	\FamilySetBool{TUD}{headinclude}{@tud@headinclude}{#1}%
	\tud@mrg@process%
}%
\newif\if@tud@footinclude
\DefineFamilyKey{TUD}{footinclude}[true]{%
	\FamilySetBool{TUD}{footinclude}{@tud@footinclude}{#1}%
	\tud@mrg@process%
}%
\def\@tud@headfoot{0}
\DefineFamilyKey{TUD}{headfoot}[true]{%
	\FamilySetNumerical{TUD}{headfoot}{@tud@headfoot}{%
		{false}{0},{off}{0},{no}{0},%
		{true}{1},{on}{1},{yes}{1},{include}{1},{both}{1},{all}{1},%
		{includehead}{2},{headinclude}{2},{head}{2},%
		{includefoot}{3},{footinclude}{3},{foot}{3}%
	}{#1}%
	\ifcase\@tud@headfoot%
		\TUDoptions{headinclude=no,footinclude=no}%
	\or%
		\TUDoptions{headinclude,footinclude}%
	\or%
		\TUDoptions{headinclude,footinclude=no}%
	\else%
		\TUDoptions{headinclude=no,footinclude}%
	\fi%
}

%****** Option für das Dresden Concept Logo im Kopf
\def\@tud@ddc{0}
\DefineFamilyKey{TUD}{ddc}[true]{%
	\FamilySetNumerical{TUD}{ddc}{@tud@ddc}{%
		{false}{0},{off}{0},{no}{0},%
		{true}{1},{on}{1},{yes}{1},%
		{tud}{2},{color}{2}%
	}{#1}%
}

%****** Verarbeitung aller Satzspiegeloptionen *********************************%
\RequirePackage{geometry}
\cmd@store{recalctypearea}
% Seitenränder über die Option geometry, sonst Berechnung durch typearea
\newlength{\@tud@mrgside}\setlength{\@tud@mrgside}{25mm}
\newlength{\@tud@mrgtop}\setlength{\@tud@mrgtop}{30mm}
\newlength{\@tud@mrgbottom}\setlength{\@tud@mrgbottom}{25mm}
\newlength{\@tud@mrgfootskip}\setlength{\@tud@mrgfootskip}{12mm}
\newlength{\@mrgoffset}%
\def\tud@mrg@process{%
	\ifcase\@tud@geometry %0 typearea
		\cmd@restore{recalctypearea}
		\KOMAoptions{BCOR=\@tud@BCOR}%
		\if@tud@headinclude
			\if@tud@footinclude%
				\KOMAoptions{headinclude,footinclude}%
			\else%
				\KOMAoptions{headinclude,footinclude=no}%
			\fi%
		\else%
			\if@tud@footinclude%
				\KOMAoptions{headinclude=no,footinclude}%
			\else%
				\KOMAoptions{headinclude=no,footinclude=no}%
			\fi%
		\fi%
		\recalctypearea%
		\setlength{\@mrgoffset}{%
			1in+\oddsidemargin+\tud@logo@x-\tud@head@dist-\@tud@BCOR%
		}%
		% Sicherstellen, dass TUD-Logo nicht außerhalb des Seitenrandes liegt
		% --> Satzspiegelverschiebung
		\ifdim\@mrgoffset<0pt
			\ClassWarningNoLine{\tud@classname}{%
				The selected page layout means that the TUD logo\MessageBreak
				extends beyond the site boundary. An additional\MessageBreak
				inner margin of \the\@mrgoffset\space is added.\MessageBreak
				Maybe you should reduce the current value\MessageBreak
				of DIV (DIV=\the\ta@div)
			}
			\addtolength{\@tud@BCOR}{-.35\@mrgoffset}% eigtl 0.33, aber reserve
			\KOMAoptions{BCOR=\@tud@BCOR}%
			\recalctypearea%
		\fi%
	% TUD (asymmetrisch)
	\or%
		\@geometryheader%
		\geometry{left=6\@tud@mrgside/5, right=4\@tud@mrgside/5}%
		\if@twoside\geometry{asymmetric}\fi%
	% symmetrischer Satz
	\or%
		\@geometryheader%
		\geometry{left=\@tud@mrgside, right=\@tud@mrgside}%
		\if@twoside%
			\geometry{left=4\@tud@mrgside/5, right=6\@tud@mrgside/5, twoside}%
		\fi%
	\fi%
}%
\def\@geometryheader{%
	\let\recalctypearea\relax%
	\geometry{%
		top=\@tud@mrgtop, bottom=\@tud@mrgbottom,%
		footskip=\@tud@mrgfootskip, bindingoffset=\@tud@BCOR%
	}%
	\if@tud@headinclude
		\if@tud@footinclude%
			\geometry{includeheadfoot}%
		\else%
			\geometry{includehead,ignorefoot}%
		\fi%
	\else%
		\if@tud@footinclude%
			\geometry{ignorehead,includefoot}%
		\else%
			\geometry{ignoreheadfoot}%
		\fi%
	\fi%
}

%*******************************************************************************%
%****** Optionen für den Schriftsatz *******************************************%
%****** tudfonts, sansmath *****************************************************%
%*******************************************************************************%

%% §§§ LuaLaTeX als Prozessor ermöglichen
%%(verschiedene Schriftschnitte fehlen als ttf/otf)
%\usepackage{fontspec}
%\setmainfont[%
%BoldFont = Univers Bold,
%ItalicFont = Univers Light Oblique,
%%BoldItalicFont = ?,
%%SlantedFont = ?,
%%BoldSlantedFont = ?
%%SmallCapsFont = ?
%]{Univers Light}
%\newfontface\dinbn{DIN Bold}
%\usepackage{unicode-math}
%\setmathfont{Latin Modern Math}

%****** Option für TUD-Schriften im Dokument ***********************************%
\newif\if@tud@tudfonts
\DefineFamilyKey{TUD}{tudfonts}[true]{%
	\FamilySetBool{TUD}{tudfonts}{@tud@tudfonts}{#1}
	\def\@setfonts{%
		\if@tud@tudfonts%
			\renewcommand*{\rmdefault}{aun}%
			\renewcommand*{\sfdefault}{aun}%
			\renewcommand*{\bfdefault}{b}%
			\renewcommand*{\mddefault}{l}%
			\renewcommand*{\familydefault}{aun}%
			\renewcommand*{\seriesdefault}{l}%
			\renewcommand*{\shapedefault}{n}%
			\renewcommand*{\rmfamily}{%
				\fontfamily{aun}\fontseries{\mddefault}\selectfont%
			}%
			\renewcommand*{\sffamily}{%
				\fontfamily{aun}\fontseries{\mddefault}\selectfont%
			}%
			\renewcommand*{\ttfamily}{%
				\fontfamily{\ttdefault}\fontseries{\tud@ori@mddefault}%
				\selectfont%
			}%
			\normalfont\selectfont%
			\FamilySetAppBool{TUD}{sansmath}{@tud@sansmath}{true}%
			\setkeys{tudpage}{tudfonts}%
		\else%
			\cmd@restore{rmdefault}%
			\cmd@restore{sfdefault}%
			\cmd@restore{bfdefault}%
			\cmd@restore{mddefault}%
			\cmd@restore{familydefault}%
			\cmd@restore{seriesdefault}%
			\cmd@restore{shapedefault}%
			\cmd@restore{rmfamily}%
			\cmd@restore{sffamily}%
			\cmd@restore{ttfamily}%
			\cmd@restore{rmdefault}%
			\cmd@restore{sfdefault}%
			\cmd@restore{ttfamily}%
			\cmd@restore{mddefault}%
			\normalfont\selectfont%
			\FamilySetAppBool{TUD}{sansmath}{@tud@sansmath}{false}%
			\setkeys{tudpage}{tudfonts=false}%
		\fi%
	}
	% Sichern der Schriften zu Beginn des Dokumentes, um evtl.
	% geladene Pakete (z.B. lmodern, cm-super) zu berücksichtigen
	\if@atdocument%
		\@setfonts%
	\else%
		\AtBeginDocument{%
			\cmd@store{rmdefault}
			\cmd@store{sfdefault}
			\cmd@store{bfdefault}
			\cmd@store{mddefault}
			\cmd@store{familydefault}
			\cmd@store{seriesdefault}
			\cmd@store{shapedefault}
			\cmd@store{rmfamily}
			\cmd@store{sffamily}
			\cmd@store{ttfamily}
			\@setfonts%
		}
		\tud@lyt@process%
	\fi%
}

%****** Option für serifenlose Matheschriften **********************************%
% Laden des Paketes sansmath
%\RequirePackage{euler}
\RequirePackage[EULERGREEK]{sansmath}
% \LaTeX-Befehl wird durch sansmath zerschossen
\newcommand*{\latex}{\begin{unsansmath}\LaTeX\end{unsansmath}}%
% und an und an lmodern anpassen §§§ LM Math einbinden
\AfterPackage!{lmodern}{%
	\SetSymbolFont{symbols}{sans}{OMS}{lmsy}{b}{n}
	\SetSymbolFont{letters}{sans}{OML}{lmm} {m}{it}
}
% zum Umschalten, ob Makros definiert sein sollen oder nicht
\newif\if@tud@sansmath
\FamilyAppBoolKey{TUD}{sansmath}{@tud@sansmath}{%
	\if@tud@sansmath%
		\sansmath%
	\else%
		\unsansmath%
	\fi%
}
%****** Bugfix des sansmath-package ********************************************%
% Überschriften nur einzeilig setzen
\AfterPackage!{metalogo}{%
	\setLaTeXa{%
		\ifx\sansm@every@math\relax%
			\check@mathfonts\fontsize\sf@size\z@\math@fontsfalse\selectfont A%
		\else%
			\scshape a%
		\fi%
	}%
}%

%*******************************************************************************%
%****** Optionen für die Verwendung des CDs ************************************%
%****** cd, cdtitle, cdtask, cdchap, cdpart ************************************%
%*******************************************************************************%

%****** Dokumentlayout *********************************************************%
\def\tud@lyt@switch{%
	{false}{0},{off}{0},{no}{0},%
	{true}{1},{on}{1},{yes}{1},%
	{simple}{1},{std}{1},{standard}{1},{mono}{1},{monochrom}{1},%
	{lite}{2},{colorlite}{2},{litecolor}{2},%
	{light}{2},{colorlight}{2},{lightcolor}{2},%
	{pale}{2},{colorpale}{2},{palecolor}{2},%
	{full}{3},{colorfull}{3},{fullcolor}{3},{color}{3},
	{alt}{4},{alter}{4},{alternative}{4},{optional}{4},{opt}{4}%
}
% globales Layout für gesamtes Dokument (title, part, chapter, task)
\DefineFamilyKey{TUD}{cd}[true]{%
	\FamilySetNumerical{TUD}{cd}{@tempa}{\tud@lyt@switch}{#1}
	% Layoutoption cd
	\renewcommand*{\tud@head@color}{black}%
	\ifcase\@tempa %0 no
		\SetLayoutDefault{tud@lyt@titl}{no}
		\SetLayoutDefault{tud@lyt@task}{no}
		\SetLayoutDefault{tud@lyt@part}{no}
		\SetLayoutDefault{tud@lyt@chap}{no}
	\or %1 on 
		\SetLayoutDefault{tud@lyt@titl}{std}
		\SetLayoutDefault{tud@lyt@task}{std}
		\SetLayoutDefault{tud@lyt@part}{std}
		\SetLayoutDefault{tud@lyt@chap}{std}
	\or %2 lite
		\SetLayoutDefault{tud@lyt@titl}{lite}
		\SetLayoutDefault{tud@lyt@task}{lite}
		\SetLayoutDefault{tud@lyt@part}{lite}
		\SetLayoutDefault{tud@lyt@chap}{lite}
		\renewcommand*{\tud@head@color}{HKS41}%
	\or %3 full
		\SetLayoutDefault{tud@lyt@titl}{full}
		\SetLayoutDefault{tud@lyt@task}{lite}
		\ifartcl{\SetLayout{tud@lyt@chap}{lite}}{%
			\SetLayout{tud@lyt@chap}{full}
			\FamilySetAppBool{TUD}{chapterpage}{@tud@chapterpage}{true}
		}
		\ifartcl{\SetLayout{tud@lyt@part}{lite}}{\SetLayout{tud@lyt@part}{full}}%
		\FamilySetAppBool{TUD}{widehead}{@tud@widehead}{true}
		\renewcommand*{\tud@head@color}{HKS41}%
	\else %4 optional
		\SetLayoutDefault{tud@lyt@titl}{opt}
		\SetLayoutDefault{tud@lyt@task}{no}
		\SetLayoutDefault{tud@lyt@part}{no}
		\SetLayoutDefault{tud@lyt@chap}{no}
	\fi%
	\tud@lyt@process%
}

%****** abweichendes Layout für titlepage **************************************%
\LayoutKey{tud@lyt@titl}
\DefineFamilyKey{TUD}{cdtitle}[true]{%
	\FamilySetNumerical{TUD}{cdtitle}{@tempa}{\tud@lyt@switch}{#1}
	\ifcase\@tempa %0
		\SetLayout{tud@lyt@titl}{no}
	\or %1
		\SetLayout{tud@lyt@titl}{std}
	\or %2
		\SetLayout{tud@lyt@titl}{lite}
	\or %3
		\SetLayout{tud@lyt@titl}{full}
	\else %4
		\SetLayout{tud@lyt@titl}{opt}
	\fi%
	\tud@lyt@process%
}

%****** kompakteres Layout für task ********************************************%
\FamilyAppBoolKey{TUD}{taskcompact}{@tud@comptask}{}


%****** abweichendes Layout für task *******************************************%
\LayoutKey{tud@lyt@task}
\DefineFamilyKey{TUD}{cdtask}[true]{%
	\FamilySetNumerical{TUD}{cdtask}{@tempa}{%
		\tud@lyt@switch,{compact}{4},{small}{4}%
	}{#1}
	\ifcase\@tempa %0
		\SetLayout{tud@lyt@task}{no}
	\or %1
		\SetLayout{tud@lyt@task}{std}
	\or %2
		\SetLayout{tud@lyt@task}{lite}
	\or %3
		\SetLayout{tud@lyt@task}{lite}
	\else %4
		\FamilySetAppBool{TUD}{taskcompact}{@tud@comptask}{true}
	\fi%
	\tud@lyt@process%
}


%****** abweichendes Layout für partpage ***************************************%
\LayoutKey{tud@lyt@part}
\DefineFamilyKey{TUD}{cdpart}[true]{%
	\FamilySetNumerical{TUD}{cdpart}{@tempa}{\tud@lyt@switch}{#1}
	\ifcase\@tempa %0
		\SetLayout{tud@lyt@part}{no}
	\or %1
		\SetLayout{tud@lyt@part}{std}
	\or %2
		\SetLayout{tud@lyt@part}{lite}
	\or %3
	%	bei tudscrartcl keine farbigen part-Seiten
		\ifartcl{\SetLayout{tud@lyt@part}{lite}}{\SetLayout{tud@lyt@part}{full}}%
	\fi%
	\tud@lyt@process%
}

%****** abweichendes Layout für chapterpage ************************************%
\LayoutKey{tud@lyt@chap}
\DefineFamilyKey{TUD}{cdchap}[true]{%
	\FamilySetAppBool{TUD}{chapterpage}{@tud@chapterpage}{false}
	\FamilySetNumerical{TUD}{cdchap}{@tempa}{\tud@lyt@switch}{#1}
	\ifcase\@tempa %0
		\SetLayout{tud@lyt@chap}{no}
	\or
		\SetLayout{tud@lyt@chap}{std}
	\or
		\SetLayout{tud@lyt@chap}{lite}
	\or
		\ifartcl{\SetLayout{tud@lyt@chap}{lite}}{%
			\SetLayout{tud@lyt@chap}{full}
			\FamilySetAppBool{TUD}{chapterpage}{@tud@chapterpage}{true}
		}
	\fi%
	\tud@lyt@process%
}

%****** Balkenbreite der Kopfzeile (Seitenrand/Blattrand) **********************%
\FamilyAppBoolKey{TUD}{widehead}{@tud@widehead}{}

%****** Titel auf den part-Seiten **********************************************%
\FamilyAppBoolKey{TUD}{parttitle}{@tud@parttitle}{\tud@lyt@process}%

%****** Seitenstil der Rückseiten von Part und Chapter (twoside) ***************%
\ifartcl{%
	% damit Schalter definiert sind
	\def\@tud@partclear{0}%
	\def\@tud@chapterclear{0}%
	\newif\if@tud@chapterpage%
	\newif\if@tud@clearcolor%
}{%
	% Rückseite von Part
	\FamilyNumericalKey{TUD}{partclear}[true]{@tud@partclear}{%
		{false}{0},{off}{0},{no}{0},%
		{true}{1},{on}{1},{yes}{1},%
		{simple}{2},{blank}{2},%
	}%
	% Rückseite von Chapter
	\FamilyNumericalKey{TUD}{chapterclear}[true]{@tud@chapterclear}{%
		{false}{0},{off}{0},{no}{0},%
		{true}{1},{on}{1},{yes}{1},%
		{simple}{2},{blank}{2}%
	}%
	% Kapitelseiten
	\FamilyAppBoolKey{TUD}{chapterpage}{@tud@chapterpage}{\tud@lyt@process}%
	% evtl. farbige Rückseiten
	\FamilyBoolKey{TUD}{clearcolor}{@tud@clearcolor}
}%
\ifundef{\if@openright}{\newif\if@openright}{}%

%****** pdfbookmarks für Titel, Inhaltsverz. und Aufgabenstellung **************%
\newcommand*{\@addbookmark}[1]{\relax}%
\providecommand*{\phantomsection}{\relax}%
\DefineFamilyKey{TUD}{bookmarks}[true]{%
	\FamilySetBool{TUD}{bookmarks}{@tempswa}{#1}%
	\AfterPackage!{hyperref}{
		\if@tempswa%
			\renewcommand*{\@addbookmark}[1]{%
				\phantomsection%
				\ifartcl{\pdfbookmark[1]{##1}{##1}}{\pdfbookmark[0]{##1}{##1}}%
			}%
		\else%
			\renewcommand*{\@addbookmark}[1]{\relax}%
		\fi%
	}%
}%
\pretocmd{\tableofcontents}{\@addbookmark{\contentsname}}{}{}

%****** Layout für Abstract ****************************************************%
\ifundef{\abstract}{}{%
	\let\tud@ori@abstract\abstract%
	\let\tud@ori@endabstract\endabstract%
	\let\abstract\relax\let\endabstract\relax
	\NewEnviron{abstract}[1][\empty]{\@@abstract{#1}}
}
\newif\if@tud@abstrchap
% Abstract in Inhaltsverzeichnis oder nicht
\FamilyAppBoolKey{TUD}{abstracttotoc}{@tud@abstrtoc}{%
	\ifundef{\tud@ori@abstract}{}{\@abstrttrue}%
}%
% zweitsprachigen Abstract auf gleiche Seite, falls möglich
\FamilyAppBoolKey{TUD}{abstractdouble}{@tud@abstrdbl}{}
\DefineFamilyKey{TUD}{abstract}[true]{%
	\FamilySetNumerical{TUD}{abstract}{@tempa}{%
		{false}{0},{off}{0},{no}{0},%
		{true}{1},{on}{1},{yes}{1},%
		{new}{2},{std}{2},{heading}{2},{chapter}{2},{chap}{2},%
		{section}{3},{sect}{3},{sec}{3},%
		{one}{4},{simple}{4},{single}{4},%
		{two}{5},{both}{5},{double}{5},{compact}{5},{small}{5},%
		{totoc}{6},{toc}{6},%
		{nottotoc}{7},{notoc}{7}%
	}{#1}%
	\ifcase\@tempa\relax% 0
		\ifundef{\tud@ori@abstract}{}{%
			\RenewEnviron{abstract}[1][\empty]{\@@abstract{##1}}%
		}%
	\or% 1
		\ifundef{\tud@ori@abstract}{}{%
			\RenewEnviron{abstract}[1][\empty]{\@@abstract{##1}}%
		}%
	\or% 2
		\ifundef{\abstract}{\NewEnviron}{\RenewEnviron}%
			{abstract}[1][\empty]{\@abstract{##1}}%
		\FamilySetAppBool{TUD}{abstracttotoc}{@tud@abstrtoc}{true}
		\ifartcl{\@tud@abstrchapfalse}{\@tud@abstrchaptrue}
	\or% 3
		\ifundef{\abstract}{\NewEnviron}{\RenewEnviron}%
			{abstract}[1][\empty]{\@abstract{##1}}%
		\FamilySetAppBool{TUD}{abstracttotoc}{@tud@abstrtoc}{true}
		\@tud@abstrchapfalse
	\or% 4
		\TUDoptions{abstractdouble=no}
	\or% 5
		\TUDoptions{abstractdouble}
	\or% 6
		\@abstrttrue%
		\TUDoptions{abstracttotoc}
	\or% 7
		\TUDoptions{abstracttotoc=no}
	\fi%
}

%****** Verarbeitung aller Layoutoptionen **************************************%
% Hilfskonstrukte
% Standardabstand, um Überschriften auf richtige Höhe zu setzen
\newlength{\@hl@voffset}\setlength{\@hl@voffset}{30mm}
% interne KOMA-Script-Variablen --> Zwischenspeichern der Schriftgröße
\let\@tud@sizetitle\size@part%
\let\@tud@sizetitleII\size@partnumber%
\let\@tud@sizesubtitle\size@section%
% Sicherung der Originalbefehle
\cmd@store{partformat}%
\cmd@store{partheadstartvskip}%
\cmd@store{partheadmidvskip}%
\cmd@store{partheadendvskip}%
\cmd@store{partheademptypage}%
\cmd@store{partpagestyle}%
\cmd@store{chapterformat}%
\cmd@store{chapterheadstartvskip}%
\cmd@store{chapterheadendvskip}%
\cmd@store{chapterpagestyle}%
\cmd@store{@makechapterhead}%
\cmd@store{@makeschapterhead}%
\cmd@store{@topnewpage}%
% Großgeschriebener Titel
\def\@titleupper{\@title}
\def\title#1{\gdef\@title{#1}\gdef\@titleupper{\MakeTextUppercase{#1}}}
% Definerter Abstand zwischen verschiedentsten Layout-Elementen
\def\tud@vskip{\par\nobreak\vskip15pt}
% Layout-Optionen ausführen
\newlength{\tud@lyt@lwtitl}%
\newlength{\tud@lyt@lwpart}
%
\newcommand*{\tud@lyt@process}{%
	%****** Title
	\ifstr{\tud@lyt@titl}{full}{%
		\setlength{\tud@lyt@lwtitl}{\tud@head@lwB}
		\def\@tud@titlpagecolor{HKS41}
		\def\@tud@titlfontcolor{HKS41!30}
		\def\@tud@titlheadcolor{white}
	}{%
		\setlength{\tud@lyt@lwtitl}{\tud@head@lwA}
		\ifstr{\tud@lyt@titl}{lite}{%
			\def\@tud@titlpagecolor{white}
			\def\@tud@titlfontcolor{HKS41}
			\def\@tud@titlheadcolor{HKS41}
		}{%
			\def\@tud@titlpagecolor{white}
			\def\@tud@titlfontcolor{black}
			\def\@tud@titlheadcolor{black}
		}
	}
	% Fußnote/Thanks im Titel ohne Großschreibung
	\cmd@store{thanks}\def\thanks##1{\NoCaseChange{\tud@ori@thanks{##1}}}%
	% Wiederherstellen
	\let\maketitle\tud@ori@maketitle
	\let\@maketitle\tud@ori@@maketitle
	\ifstr{\tud@lyt@titl}{no}{}{%
		\renewcommand*\maketitle[1][1]{%
			\if@titlepage
				\begin{titlepage}%
					\@tud@titlefnt%
					\renewcommand*\next@tpage{%
						\clearpage%
						\pagecolor{white}%
						\color{black}%
						\thispagestyle{empty}%
					}%
					\setlength{\parindent}{\z@}%
					\setlength{\parfillskip}{\fill}%
					\setcounter{page}{##1}%
					\let\footnotesize\small%
					\let\footnoterule\relax%
					\let\footnote\thanks%
					\renewcommand*\thefootnote{\@fnsymbol\c@footnote}%
					\let\@oldmakefnmark\@makefnmark%
					\renewcommand*{\@makefnmark}{\rlap\@oldmakefnmark}%
					\ifx\@extratitle\@empty\else%
						\noindent\@extratitle\next@tpage\cleardoubleemptypage%
						\thispagestyle{empty}%
					\fi%
					\pagecolor{\@tud@titlpagecolor}%
					\ifstr{\tud@lyt@titl}{opt}{%
						\@tud@title%
					}{%
						\renewcommand*{\tud@head@color}{\@tud@titlheadcolor}%
						\setlength{\tud@head@lw}{\tud@lyt@lwtitl}%
						\setkeys{tudpage}{tudfonts}%
						\@tud@cdtitle%
					}%
					\if@twoside
						\next@tpage%
						\if@openright\if@tud@clearcolor%
							\pagecolor{\@tud@titlpagecolor}%
							\color{\@tud@titlfontcolor}%
						\fi\fi%
						\begin{minipage}[t]{\textwidth}%
							\@uppertitleback%
						\end{minipage}\par%
						\vfill%
						\begin{minipage}[b]{\textwidth}%
							\@lowertitleback%
						\end{minipage}%
					\fi%
					\ifx\@dedication\@empty\else%
						\next@tpage%
						\null%
						\vfill%
						{\centering\Large\@dedication\par}%
						\vskip\z@\@plus3fill%
						\if@twoside\next@tpage\cleardoubleemptypage\fi%
					\fi%
				\end{titlepage}%
				\pagecolor{white}\color{black}%
				\setcounter{footnote}{0}%
			\else%
				\let\@maketitle\@tud@maketitle%
				\tud@ori@maketitle%
			\fi%
		}%
	}%
	\pretocmd{\maketitle}{\@addbookmark{\titlepagename}}{}{}
	\apptocmd{\maketitle}{%
		\let\thanks\relax
		\let\maketitle\relax
		\let\@maketitle\relax
		\let\@tud@title\relax%
		\let\@tud@cdtitle\relax%
		\let\@tud@maketitle\relax%
		\let\@tud@titlefnt\relax%
		\global\let\@thanks\@empty
		\global\let\@title\@empty
		\global\let\@author\@empty
		\global\let\@moreauthor\@empty
		\global\let\@date\@empty
		\global\let\@subtitle\@empty
		\global\let\@extratitle\@empty
		\global\let\@titlehead\@empty
		\global\let\@subject\@empty
		\global\let\@publishers\@empty
		\global\let\@uppertitleback\@empty
		\global\let\@lowertitleback\@empty
		\global\let\@dedication\@empty
		\global\let\author\relax
		\global\let\title\relax
		\global\let\extratitle\relax
		\global\let\titlehead\relax
		\global\let\subject\relax
		\global\let\publishers\relax
		\global\let\uppertitleback\relax
		\global\let\lowertitleback\relax
		\global\let\dedication\relax
		\global\let\date\relax
		\global\let\and\relax
	}{}{}%
	% Titel vor maketitle sichern, um später noch verwenden zu können
	\pretocmd{\maketitle}{\cmd@store{@title}\cmd@store{@author}}{}{}
	\apptocmd{\maketitle}{\cmd@restore{@title}\cmd@restore{@author}}{}{}
	% evtl. vorhandene thanks-Einträge nachfolgend ignorieren
	\apptocmd{\maketitle}{\def\thanks##1{\relax}}{}{}
	
	%****** Part
	% Seitenstil
	\cmd@restore{partformat}%
	\cmd@restore{partheadstartvskip}%
	\cmd@restore{partheadmidvskip}%
	\cmd@restore{partheadendvskip}%
	\cmd@restore{partheademptypage}%
	\cmd@restore{partpagestyle}%
	\sect@reset[addpart]{part}%
	\font@reset{partnumber}%
	% Farben
	\ifstr{\tud@lyt@part}{full}{%
		\setlength{\tud@lyt@lwpart}{\tud@head@lwB}%
		\def\@tud@partpagecolor{HKS41}%
		\def\@tud@partfontcolor{HKS41!30}%
		\def\@tud@partheadcolor{white}%
		\renewcommand*{\partpagestyle}{empty}
	}{%
		\setlength{\tud@lyt@lwpart}{\tud@head@lwA}%
		\ifstr{\tud@lyt@part}{lite}{%
			\def\@tud@partpagecolor{white}%
			\def\@tud@partfontcolor{HKS41}%
			\def\@tud@partheadcolor{HKS41}%
		}{%
			\def\@tud@partpagecolor{white}%
			\def\@tud@partfontcolor{black}%
			\def\@tud@partheadcolor{black}%
		}%
	}%
	% String für Titel auf Part-Seiten
	\def\@parttitlestring{%
		\begingroup%
		\normalfont%
		\sectfont\dinbn\nobreak\color{\@tud@partfontcolor}%
		\@tud@sizetitle\@titleupper\tud@vskip%
		\endgroup%
	}%
	\ifartcl{%
		\ifstr{\tud@lyt@part}{no}{%
			% Überschriften in FF DIN Bold und groß
			\if@tud@tudfonts%
				\sect@set[addpart]{part}{\dinbn}%
				\font@set{partnumber}{\dinbn}%
			\fi%
			\if@tud@parttitle%
				\ClassWarningNoLine{\tud@classname}{%
					The key parttitle is not supported by layout cdpart=false
				}
			\fi
		}{%
			% Überschriften in FF DIN Bold und groß
			\if@tud@parttitle%
				\sect@set[addpart]{part}{%
					\color{\@tud@partfontcolor}\@tud@sizesubtitle\dinbn%
				}%
				\font@set{partnumber}{%
					\color{\@tud@partfontcolor}\@tud@sizesubtitle\dinbn%
				}%
				\renewcommand*{\partheadmidvskip}{\enskip}%
				\apptocmd{\partheadstartvskip}{\@parttitlestring}{}{}
			\else
				\sect@set[addpart]{part}{\color{\@tud@partfontcolor}\dinbn}%
				\font@set{partnumber}{\color{\@tud@partfontcolor}\dinbn}%
			\fi%
		}%
	}{%
		\ifstr{\tud@lyt@part}{no}{%
			% Überschriften in FF DIN Bold und groß
			\if@tud@tudfonts%
				\sect@set[addpart]{part}{\dinbn}%
				\font@set{partnumber}{\dinbn}%
			\fi%
			\if@tud@parttitle%
				\ClassWarningNoLine{\tud@classname}{%
					parttitle is not supported by layout cdpart=false
				}
			\fi
			\renewcommand*{\partheademptypage}{%
				\if@twoside\if@openright%
					\ifcase\@tud@partclear\or%
						\null\thispagestyle{empty}\newpage%
					\else%
						\cleardoubleoddpage%
					\fi%
				\fi\fi%
			}%
		}{%
			% Überschriften in FF DIN Bold und groß
			\if@tud@parttitle%
				\sect@set[addpart]{part}{%
					\color{\@tud@partfontcolor}\@tud@sizesubtitle\dinbn%
				}%
				\font@set{partnumber}{%
					\color{\@tud@partfontcolor}\@tud@sizesubtitle\dinbn%
				}%
				\renewcommand*{\partheadmidvskip}{\enskip}%
			\else%
				\sect@set[addpart]{part}{\color{\@tud@partfontcolor}\dinbn}%
				\font@set{partnumber}{\color{\@tud@partfontcolor}\dinbn}%
				\pretocmd{\partformat}{%
					\vspace*{-\dp\strutbox}\vspace*{-\ht\strutbox}%
					\vspace*{-.5\baselineskip}%
				}{}{}%
				\renewcommand*{\partheadmidvskip}{\vskip.5\baselineskip}%
			\fi%
			\renewcommand*{\partheadstartvskip}{%
				\vspace*{\@hl@voffset}\vspace*{\headingsvskip}\vspace*{\parskip}%
				\if@tud@parttitle\@parttitlestring\fi%
			}%
			\renewcommand*{\partheadendvskip}{%
				\tud@areaset%
				\pagecolor{\@tud@partpagecolor}%
				\bgroup%
				\renewcommand*{\tud@head@color}{\@tud@partheadcolor}%
				\setkeys{tudpage}{tudfonts}%
				\ifstr{\partpagestyle}{empty}%
					{\renewcommand*{\partpagestyle}{@tudpage}}%
					{\renewcommand*{\partpagestyle}{tudpage}}%
				\setlength{\tud@head@lw}{\tud@lyt@lwpart}%
				\addtokomafont{pagenumber}{\color{\@tud@partfontcolor}}%
				\clearpage%
			}%
			\renewcommand*{\partheademptypage}{%
				\ifboolexpr{bool {@twoside} and bool {@openright}}
				{%
					\if@tud@clearcolor
						\ifcase\@tud@partclear\or%
							\null\thispagestyle{empty}\newpage%
						\else%
							\cleardoubleoddpage%
						\fi%
						\pagecolor{white}%
						\egroup%
					\else%
						\egroup%
						\pagecolor{white}%
						\ifcase\@tud@partclear\or%
							\null\thispagestyle{empty}\newpage%
						\else%
							\cleardoubleoddpage%
						\fi%
					\fi%
				}{\pagecolor{white}\egroup}%
			}%
		}%	
	}%
	%****** Chapter
	% Seitenstil
	\sect@reset[addchap]{chapter}%
	\sect@reset[addsec]{section}%
	\sect@reset{subsection}%
	\sect@reset{subsubsection}%
	\sect@reset{minisec}%
	\font@reset{chapterprefix}%
	\cmd@restore{chapterheadstartvskip}%
	\cmd@restore{chapterheadendvskip}%
	\cmd@restore{chapterformat}%
	\cmd@restore{chapterpagestyle}%
	\cmd@restore{@makechapterhead}%
	\cmd@restore{@makeschapterhead}%
	\cmd@restore{@topnewpage}%
	% Farben
	\ifstr{\tud@lyt@chap}{full}{%
		\def\@tud@chappagecolor{HKS41!10}%
		\def\@tud@chapfontcolor{HKS41}%
	}{\ifstr{\tud@lyt@chap}{lite}{%
			\def\@tud@chappagecolor{white}%
			\def\@tud@chapfontcolor{HKS41}%
		}{%
			\def\@tud@chappagecolor{white}%
			\def\@tud@chapfontcolor{black}%
		}%
	}%
	\ifartcl{%
		\ifstr{\tud@lyt@chap}{no}{%
			% Überschriften in FF DIN Bold und groß
			\if@tud@tudfonts%
				\sect@set[addsec]{section}{\dinbn}%
				\sect@set{subsection}{\dinbn}%
				\sect@set{subsubsection}{\dinbn}%
				\sect@minisec{\dinbn}%
			\fi%
		}{%
			% Überschriften in FF DIN Bold und groß
			\sect@set[addsec]{section}{\dinbn}%
			\sect@set{subsection}{\dinbn}%
			\sect@set{subsubsection}{\dinbn}%
			\sect@minisec{\dinbn}%
		}%
	}{%
		\ifstr{\tud@lyt@chap}{no}{%
			% Überschriften in FF DIN Bold und groß
			\if@tud@tudfonts%
				\sect@set[addchap]{chapter}{\dinbn}%
				\sect@set[addsec]{section}{\dinbn}%
				\sect@set{subsection}{\dinbn}%
				\sect@set{subsubsection}{\dinbn}%
				\sect@minisec{\dinbn}%
			\fi%
			\apptocmd{\chapterheadstartvskip}{\vspace*{\headingsvskip}}{}{}%
			\if@tud@chapterpage%
				\renewcommand*{\chapterheadendvskip}{%
					\clearpage%
					\ifboolexpr{bool {@twoside} and bool {@openright}}
					{%
						\ifcase\@tud@chapterclear\or%
							\null\thispagestyle{empty}\newpage%
						\else%
							\cleardoubleoddpage%
						\fi%
					}{}
				}%
			\fi%
		}{%
			% Überschriften in FF DIN Bold und groß
			\sect@set[addchap]{chapter}{%
				\@tud@sizetitle\color{\@tud@chapfontcolor}\dinbn%
			}%
			\sect@set[addsec]{section}{\dinbn}%
			\sect@set{subsection}{\dinbn}%
			\sect@set{subsubsection}{\dinbn}%
			\sect@minisec{\dinbn}
			\font@set{chapterprefix}{\@tud@sizetitleII}%
			\pretocmd{\chapterformat}{\vspace*{-\dp\strutbox}}{}{}
			\renewcommand*{\chapterheadstartvskip}{%
				\tud@head@calc\vspace*{\tud@head@diff}%
				\vspace*{\@hl@voffset}\vspace*{\headingsvskip}%
			}%
			\if@tud@chapterpage%
				\long\def\@topnewpage[##1]{##1}
				\renewcommand*{\chapterpagestyle}{\partpagestyle}%
				\renewcommand*{\chapterheadendvskip}{}%
				\def\clear@chapterpage{%
					\begingroup%
					\setkeys{tudpage}{tudfonts}%
					\pagecolor{\@tud@chappagecolor}%
					\addtokomafont{pagenumber}{\color{\@tud@chapfontcolor}}%
					\clearpage%
					\ifboolexpr{bool {@twoside} and bool {@openright}}
					{%
					\if@tud@clearcolor
						\ifcase\@tud@chapterclear\or%
							\null\thispagestyle{empty}\newpage%
						\else%
							\cleardoubleoddpage%
						\fi%
						\pagecolor{white}%
						\endgroup%
					\else%
						\endgroup%
						\pagecolor{white}%
						\ifcase\@tud@chapterclear\or%
							\null\thispagestyle{empty}\newpage%
						\else%
							\cleardoubleoddpage%
						\fi%
					\fi%
					}{\pagecolor{white}\endgroup}%
				}
				\apptocmd{\@makechapterhead}{\clear@chapterpage}{}{}%
				\apptocmd{\@makeschapterhead}{\clear@chapterpage}{}{}%
			\fi%
			\apptocmd{\chapterheadendvskip}{%
				\renewcommand{\tud@head@color}{\@tud@chapfontcolor}%
			}{}{}%
		}%
	}%
}%

% Befehle für Großschreibung und Formatierung der Überschriften im Dokument
\newcommand*{\sect@set}[2][\@empty]{%\sect@set[addsect]{sect/font}{fontdef}
	% Sichern Original
	\cmd@store{#2}%
	% Großschreibung
	\sect@case@set{#2}%
	% mögliche add...-Befehle
	\ifx#1\@empty\else%
		\cmd@store{#1}%
		\sect@case@set{#1}%
	\fi%
	% Großschreibung von "Teil" und "Kapitel" sicherstellen
	\ifstr{#2}{part}{\gdef\part@case{\MakeTextUppercase}}{}%
	\ifstr{#2}{chapter}{\gdef\chapter@case{\MakeTextUppercase}}{}%
	\font@set{#2}%
}%
% Makro für die unterschiedliche Behandlung der einzelnen Gliederungsbefehle
% (Großschreibung nur im Dokument, nicht in Kopf und Verzeichnissen)
\def\sect@case@set#1{%
	% Unterscheidung Sternversion
	\expandafter\def\csname#1\endcsname{%
		\expandafter\@ifstar\csname tud@#1s\expandafter\endcsname%
		\csname tud@#1\endcsname%
	}%
	% Unterscheidung Version mit optionalem Argument
	\expandafter\def\csname tud@#1\endcsname{%
		\@ifnextchar[{\csname tud@#1o\endcsname}{\csname tud@#1n\endcsname}
	}
	% Definition normale Version
	\expandafter\def\csname tud@#1n\expandafter\endcsname##1{%
		\expandafter\csname tud@ori@#1\endcsname[##1]{\MakeTextUppercase{##1}}%
	}%
	% Definition optionale Version
	\expandafter\def\csname tud@#1o\expandafter\endcsname[##1]##2{%
		\expandafter\csname tud@ori@#1\endcsname[##1]{\MakeTextUppercase{##2}}%
	}
	% Definition Sternversion
	\expandafter\def\csname tud@#1s\expandafter\endcsname##1{%
		\expandafter\csname tud@ori@#1\endcsname*{\MakeTextUppercase{##1}}%
	}%
}
\def\font@set#1#2{%\font@set{font}{fontdef}
	\ifcsdef{tud@fnt@#1}{}{\addtokomafont{#1}{\csname tud@fnt@#1\endcsname}}%
	\expandafter\def\csname tud@fnt@#1\endcsname{#2}%
}
\newcommand*{\sect@minisec}[1]{%\sect@minisec{fontdef}
	\cmd@store{minisec}%
	\def\minisec##1{\tud@ori@minisec{\MakeTextUppercase{##1}}}%
	\font@set{minisec}{#1}%
}
% Zurücksetzen der Überschriften
\newcommand*{\sect@reset}[2][\@empty]{%\sect@reset[addsect]{sect/font}
	% Sichern und Großschreibung
	\cmd@restore{#2}%
	\ifx#1\@empty\else%
		\cmd@restore{#1}%
	\fi%
	\ifstr{#2}{part}{\gdef\part@case{}}{}%
	\ifstr{#2}{chapter}{\gdef\chapter@case{}}{}%
	\font@reset{#2}%
}
\def\font@reset#1{%
	\ifcsdef{tud@fnt@#1}{\expandafter\def\csname tud@fnt@#1\endcsname{\relax}}{}%
}
% Hilfskonstrukte für Präfixe
\def\sect@case@cmd#1{%
	\expandafter\let\csname temp@#1\expandafter\endcsname%
	\csname #1format\endcsname%
	\expandafter\def\csname #1format\endcsname{%
		\expandafter\csname #1@case\endcsname%
			{\expandafter\csname temp@#1\endcsname}%
	}%
}
% Makro, um Großschreibung für Part-Präfix zu gewährleisten
\sect@case@cmd{part}
% Makro, um Großschreibung für Chapter-Präfix zu gewährleisten
\sect@case@cmd{chapter}

% Befehle für die Präambeln von \part und \chapter
\ifartcl{}{%
	\cmd@store{setpartpreamble}
	\cmd@store{setchapterpreamble}
	\renewcommand{\setpartpreamble}[1][lu]{%
		\begingroup
	    \edef\@preamble@loc{#1}%
	    \@setpartpreamble
	}
	\newcommand{\@setpartpreamble}[2][\hsize]{%
		\expandafter\tud@ori@setpartpreamble\expandafter[\@preamble@loc][{#1}]{%
			\@tud@abstrchapfalse%
			\KOMAoptions{titlepage=false}%
			\addtokomafont{disposition}{\color{\@tud@partfontcolor}}%
			\addtokomafont{dictumtext}{\color{\@tud@partfontcolor}}%
			\color{\@tud@partfontcolor}%
			\ifstr{\tud@lyt@part}{no}{}{\TUDoptions{tudfonts}}
			#2%
	  }%
	  \endgroup%
	}
	\renewcommand{\setchapterpreamble}[1][lu]{%
		\begingroup
		\edef\@preamble@loc{#1}%
		\@setchapterpreamble
	}
	\newcommand{\@setchapterpreamble}[2][\hsize]{%
		\expandafter\tud@ori@setchapterpreamble\expandafter%
			[\@preamble@loc][{#1}]{%
			\@tud@abstrchapfalse%
			\KOMAoptions{titlepage=false}%
			\if@tud@chapterpage
				\addtokomafont{disposition}{\color{\@tud@chapfontcolor}}%
				\addtokomafont{dictumtext}{\color{\@tud@chapfontcolor}}%
				\color{\@tud@chapfontcolor}%
			\fi%
			\ifstr{\tud@lyt@chap}{no}{}{\TUDoptions{tudfonts}}
			#2%
	  }%
	  \endgroup%
	}
}

%*******************************************************************************%
%****** Kompatibilität zu tudbook **********************************************%
%*******************************************************************************%
\let\einrichtung\faculty%
\let\fachrichtung\department%
\let\institut\institute%
\let\professur\chair%

% Setzen der Bezeichnung der Arbeit in die Betreffzeile der Titlelseite
\FamilyBoolKey{TUD}{subjectthesis}{@tud@subthesis}

% Kopf- und Fußzeilen wie im Originalvorlage tudbook
\FamilyBoolKey{TUD}{tudfoot}{@tud@foot}
\def\set@tudfoot{%
	\if@tud@foot%
		\RequirePackage[automark,autooneside]{scrpage2}%
		\clearscrheadfoot%
		\ifartcl{}{%
			\renewcommand*{\chaptermarkformat}{%
				\chapapp~\thechapter\autodot\enskip%
			}%
		}%
		\setkomafont{pageheadfoot}{\normalfont}%
		\setkomafont{pagenumber}{\normalfont}%
		\lefoot[\footnotesize\pagemark]{%
			\footnotesize\pagemark\quad\scriptsize\headmark%
		}%
		\rofoot[\footnotesize\pagemark]{%
			\scriptsize\headmark\quad\footnotesize\pagemark%
		}%
		\pagestyle{scrheadings}%
		\TUDoptions{headfoot=no}%
		\recalctypearea%
	\fi%
}%

% Schlüssel für farbiges Layout
\DefineFamilyKey{TUD}{color}[true]{%
	\FamilySetBool{TUD}{color}{@tempswa}{#1}%
	\if@tempswa%
		\TUDoptions{cd=full}%
	\else%
		\TUDoptions{cd=on}%
	\fi%
}%

% Einbindung eines Zweilogos
\let\logofilename\logofile%

% Befehl zum Erzeugen von separaten Kapitelseiten
\newif\if@tud@cptmp%
\newif\if@tud@cptgl%
\newcommand*{\chapterpage}{%
	\ClassWarning{\tud@classname}{%
		The command \string\chapterpage\space is not recommended.\MessageBreak
		You should use the same chapterstyle\MessageBreak
		for the whole document.\MessageBreak
	}%
	\@tud@cptmptrue%
}%
\pretocmd{\chapter}{\tud@cppre}{}{}
\pretocmd{\addchap}{\tud@cppre}{}{}
\def\tud@cppre{%
	\ifboolexpr{(bool{@tud@cptmp} and not bool {@tud@cptgl}) or
		(not bool{@tud@cptmp} and bool {@tud@cptgl})}
	{%
		\clearpage%
		\if@tud@chapterpage%
			\TUDoptions{chapterpage=false}
		\else%
			\TUDoptions{chapterpage=true}
		\fi
		\if@tud@cptmp%
			\@tud@cptgltrue%
		\else			
			\@tud@cptglfalse%
		\fi%
	}{}%
	\@tud@cptmpfalse%
}%

% einfaches Glossar
\providecommand*{\glossaryname}{Glossar}
\newenvironment{theglossary}[1][]{%
	\ClassWarningNoLine{\tud@classname}{%
		Using the environment theglossary is not recommended.\MessageBreak
		Use a package instead, e.g. glossaries.\MessageBreak
	}
    \addchap{\glossaryname}%
    #1%
    \begin{list}{}{%
    	\setlength{\labelsep}{0pt}%
    	\setlength{\labelwidth}{0pt}%
    	\setlength{\itemindent}{-\leftmargin}%
    }%
}{\end{list}}
\newcommand{\glossitem}[1]{\item[] #1\par}%

% Schalter Matheschriften
\DefineFamilyKey{TUD}{serifmath}[true]{%
	\FamilySetBool{TUD}{serifmath}{@tempswa}{#1}
	\if@tempswa%
		\TUDoptions{sansmath=false}%
	\else%
		\TUDoptions{sansmath=true}%
	\fi%
}

%*******************************************************************************%
%****** Standardwerte setzen ***************************************************%
%*******************************************************************************%
\FamilyExecuteOptions{TUD}{cd,tudfonts,geometry,bookmarks,partclear}
\FamilyExecuteOptions{TUD}{\CurrentOption}
\FamilyProcessOptions{TUD}
\set@tudfoot
\endinput